{% extends 'productos/base.html' %}
{% load static %}

{% block content %}

<!-- ================= CAROUSEL PREMIUM FULL-WIDTH ================= -->
<div class="carousel-container">
    <div class="carousel-wrapper">
        <!-- Slides -->
        <div class="carousel-slide active">
            <img src="https://images.unsplash.com/photo-1577384163767-a077c89069ce?q=80&w=1920&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" 
                 alt="Mostrador de pescadería con pescados frescos sobre hielo">
            <div class="carousel-caption">
                <h2>Calidad Premium del Mar</h2>
                <p>Pescados y mariscos de primera selección</p>
            </div>
        </div>
        
        <div class="carousel-slide">
            <img src="https://images.unsplash.com/photo-1518837695005-2083093ee35b?q=80&w=1920&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" 
                 alt="Venta de pescado en mercado artesanal">
            <div class="carousel-caption">
                <h2>Frescura Garantizada</h2>
                <p>Directamente del mar a tu mesa</p>
            </div>
        </div>
        
        <div class="carousel-slide">
            <img src="https://images.unsplash.com/photo-1599083856001-ebe325a41162?q=80&w=1920&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" 
                 alt="Filetes de salmón listos para la venta">
            <div class="carousel-caption">
                <h2>Productos Premium</h2>
                <p>La mejor calidad al mejor precio</p>
            </div>
        </div>
        
        <!-- Flechas de navegación -->
        <button class="carousel-prev" onclick="cambiarSlide(-1)" aria-label="Anterior">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button class="carousel-next" onclick="cambiarSlide(1)" aria-label="Siguiente">
            <i class="fas fa-chevron-right"></i>
        </button>
        
        <!-- Indicadores (dots) -->
        <div class="carousel-indicators">
            <span class="indicator active" onclick="irASlide(0)"></span>
            <span class="indicator" onclick="irASlide(1)"></span>
            <span class="indicator" onclick="irASlide(2)"></span>
        </div>
    </div>
</div>

<!-- ================= CONTENEDOR PRINCIPAL ================= -->
<div class="lista-container">
    <h1>Productos</h1>

    <!-- ================= FORMULARIO DE FILTROS ================= -->
    <form method="get" class="filtros">
        <!-- Búsqueda por texto -->
        <input type="text" name="q" placeholder="Buscar producto..." value="{{ request.GET.q|default:'' }}">
        <!-- Filtrado por categoría -->
        <select name="categoria">
            <option value="">Todas las categorías</option>
            {% for cat in categorias %}
                <option value="{{ cat.id }}" {% if request.GET.categoria == cat.id|stringformat:"s" %}selected{% endif %}>
                    {{ cat.nombre }}
                </option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">Filtrar</button>
    </form>
    <!-- FEEDBACK: permite al usuario buscar y filtrar productos fácilmente -->

    <!-- ================= GRID DE PRODUCTOS ================= -->
    <div class="productos-grid">
        {% for producto in productos %}
            <div class="producto-card">
                <div class="producto-card__image-wrapper">
                    {% if producto.descuento > 0 %}
                        <span class="producto-card__badge" aria-label="Descuento disponible">-{{ producto.descuento|floatformat:0 }}% OFF</span>
                    {% endif %}
                    <a href="{% url 'detalle_producto' producto.id %}" class="producto-card__image-link">
                        {% if producto.imagen %}
                            <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="producto-card__image">
                        {% else %}
                            <img src="https://via.placeholder.com/300" alt="Sin imagen" class="producto-card__image">
                        {% endif %}
                    </a>
                </div>

                <div class="producto-card__info">
                    {% if producto.categoria %}
                        <span class="producto-card__category">{{ producto.categoria.nombre }}</span>
                    {% endif %}
                    <h3 class="producto-card__title">
                        <a href="{% url 'detalle_producto' producto.id %}">{{ producto.nombre }}</a>
                    </h3>

                    <div class="producto-card__stock-row">
                        {% if producto.stock == 0 %}
                            <span class="producto-card__stock producto-card__stock--out">Sin stock</span>
                        {% elif producto.stock > 0 and producto.stock < 10 %}
                            <span class="producto-card__stock producto-card__stock--low">Quedan {{ producto.stock }} en stock</span>
                        {% else %}
                            <span class="producto-card__stock producto-card__stock--in">Disponible</span>
                        {% endif %}
                    </div>

                    <div class="producto-card__price-row">
                        <div class="producto-card__prices">
                            {% if producto.descuento > 0 %}
                                <span class="producto-card__price-old">${{ producto.precio }}</span>
                                <span class="producto-card__price-current">${{ producto.precio_con_descuento|floatformat:2 }}</span>
                            {% else %}
                                <span class="producto-card__price-current">${{ producto.precio }}</span>
                            {% endif %}
                        </div>
                        <a class="producto-card__cta" href="{% url 'detalle_producto' producto.id %}">Ver detalle</a>
                    </div>
                </div>
            </div>
        {% empty %}
            <!-- FEEDBACK: si no hay productos que mostrar -->
            <p>No hay productos disponibles.</p>
        {% endfor %}
    </div>
</div>

<!-- ================= SCRIPT CAROUSEL AUTO-SLIDE ================= -->
<script>
let slideActual = 0;
let intervaloCarousel;

function mostrarSlide(n) {
    const slides = document.querySelectorAll('.carousel-slide');
    const indicators = document.querySelectorAll('.indicator');
    
    // Ajustar índice si se sale del rango
    if (n >= slides.length) { slideActual = 0; }
    if (n < 0) { slideActual = slides.length - 1; }
    
    // Ocultar todos los slides
    slides.forEach(slide => slide.classList.remove('active'));
    indicators.forEach(indicator => indicator.classList.remove('active'));
    
    // Mostrar slide actual
    slides[slideActual].classList.add('active');
    indicators[slideActual].classList.add('active');
}

function cambiarSlide(direccion) {
    slideActual += direccion;
    mostrarSlide(slideActual);
    reiniciarIntervalo();
}

function irASlide(n) {
    slideActual = n;
    mostrarSlide(slideActual);
    reiniciarIntervalo();
}

function avanzarAutomatico() {
    slideActual++;
    mostrarSlide(slideActual);
}

function reiniciarIntervalo() {
    clearInterval(intervaloCarousel);
    intervaloCarousel = setInterval(avanzarAutomatico, 5000);
}

// Iniciar auto-slide al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    intervaloCarousel = setInterval(avanzarAutomatico, 5000);
});

// Pausar auto-slide al pasar el mouse
document.querySelector('.carousel-wrapper').addEventListener('mouseenter', function() {
    clearInterval(intervaloCarousel);
});

// Reanudar auto-slide al quitar el mouse
document.querySelector('.carousel-wrapper').addEventListener('mouseleave', function() {
    intervaloCarousel = setInterval(avanzarAutomatico, 5000);
});
</script>

{% endblock %}
